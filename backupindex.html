import React, { useState, useEffect } from 'react';
import { Dumbbell, TrendingUp, Calendar, Award, User, ChevronLeft, ChevronRight, Save, X } from 'lucide-react';
import { LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';

const GymTracker = () => {
  const [currentDate, setCurrentDate] = useState(new Date());
  const [showWeightModal, setShowWeightModal] = useState(false);
  const [selectedPerson, setSelectedPerson] = useState(null);
  const [tempWeight, setTempWeight] = useState('');
  const [data, setData] = useState({});
  const [loading, setLoading] = useState(true);
  const [viewMode, setViewMode] = useState('dashboard'); // dashboard, calendar, charts

  // Carregar dados do storage
  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    try {
      const result = await window.storage.get('gym-tracker-data');
      if (result) {
        setData(JSON.parse(result.value));
      }
    } catch (error) {
      console.log('Iniciando com dados vazios');
    } finally {
      setLoading(false);
    }
  };

  const saveData = async (newData) => {
    try {
      await window.storage.set('gym-tracker-data', JSON.stringify(newData));
      setData(newData);
    } catch (error) {
      console.error('Erro ao salvar:', error);
    }
  };

  const getDateKey = (date) => {
    return date.toISOString().split('T')[0];
  };

  const toggleGym = async (person) => {
    const dateKey = getDateKey(currentDate);
    const newData = { ...data };
    
    if (!newData[dateKey]) {
      newData[dateKey] = {
        kamilaGym: false,
        ramonGym: false,
        kamilaWeight: null,
        ramonWeight: null
      };
    }
    
    if (person === 'kamila') {
      newData[dateKey].kamilaGym = !newData[dateKey].kamilaGym;
    } else {
      newData[dateKey].ramonGym = !newData[dateKey].ramonGym;
    }
    
    await saveData(newData);
  };

  const openWeightModal = (person) => {
    setSelectedPerson(person);
    const dateKey = getDateKey(currentDate);
    const currentWeight = data[dateKey]?.[`${person}Weight`] || '';
    setTempWeight(currentWeight);
    setShowWeightModal(true);
  };

  const saveWeight = async () => {
    if (!tempWeight || isNaN(tempWeight)) return;
    
    const dateKey = getDateKey(currentDate);
    const newData = { ...data };
    
    if (!newData[dateKey]) {
      newData[dateKey] = {
        kamilaGym: false,
        ramonGym: false,
        kamilaWeight: null,
        ramonWeight: null
      };
    }
    
    newData[dateKey][`${selectedPerson}Weight`] = parseFloat(tempWeight);
    await saveData(newData);
    setShowWeightModal(false);
    setTempWeight('');
  };

  // Estat√≠sticas
  const calculateStats = () => {
    const today = getDateKey(currentDate);
    const todayData = data[today] || { kamilaGym: false, ramonGym: false };
    
    let kamilaTotal = 0, ramonTotal = 0;
    let kamilaDays = 0, ramonDays = 0;
    const entries = Object.keys(data);
    
    entries.forEach(key => {
      if (data[key].kamilaGym) kamilaTotal++;
      if (data[key].ramonGym) ramonTotal++;
    });
    
    // Dias √∫nicos
    kamilaDays = entries.filter(k => data[k].kamilaGym).length;
    ramonDays = entries.filter(k => data[k].ramonGym).length;
    
    // √öltimos pesos
    const sortedKeys = entries.sort().reverse();
    let lastKamilaWeight = null, lastRamonWeight = null;
    
    for (let key of sortedKeys) {
      if (!lastKamilaWeight && data[key].kamilaWeight) {
        lastKamilaWeight = data[key].kamilaWeight;
      }
      if (!lastRamonWeight && data[key].ramonWeight) {
        lastRamonWeight = data[key].ramonWeight;
      }
      if (lastKamilaWeight && lastRamonWeight) break;
    }
    
    return {
      todayKamila: todayData.kamilaGym,
      todayRamon: todayData.ramonGym,
      kamilaTotal,
      ramonTotal,
      kamilaDays,
      ramonDays,
      lastKamilaWeight,
      lastRamonWeight
    };
  };

  const getMonthData = () => {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    
    const days = [];
    for (let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
      const dateKey = getDateKey(new Date(d));
      const dayData = data[dateKey] || { kamilaGym: false, ramonGym: false };
      days.push({
        date: new Date(d),
        dateKey,
        ...dayData
      });
    }
    return days;
  };

  const getWeightChartData = () => {
    const entries = Object.keys(data).sort().slice(-30);
    return entries.map(key => ({
      date: new Date(key).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }),
      Kamila: data[key].kamilaWeight || null,
      Ramon: data[key].ramonWeight || null
    })).filter(d => d.Kamila !== null || d.Ramon !== null);
  };

  const getFrequencyChartData = () => {
    const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
    const monthlyData = {};
    
    Object.keys(data).forEach(key => {
      const date = new Date(key);
      const monthKey = `${monthNames[date.getMonth()]}/${date.getFullYear().toString().slice(-2)}`;
      
      if (!monthlyData[monthKey]) {
        monthlyData[monthKey] = { month: monthKey, Kamila: 0, Ramon: 0 };
      }
      
      if (data[key].kamilaGym) monthlyData[monthKey].Kamila++;
      if (data[key].ramonGym) monthlyData[monthKey].Ramon++;
    });
    
    return Object.values(monthlyData).slice(-12);
  };

  const stats = calculateStats();
  const monthData = getMonthData();

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
        <div className="text-white text-2xl animate-pulse">Carregando...</div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white p-4 md:p-8">
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@900&family=Inter:wght@400;600&display=swap');
        
        .title-font {
          font-family: 'Montserrat', sans-serif;
          font-weight: 900;
          letter-spacing: -0.02em;
        }
        
        .body-font {
          font-family: 'Inter', sans-serif;
        }
        
        .card {
          background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.9));
          backdrop-filter: blur(20px);
          border: 1px solid rgba(255, 255, 255, 0.1);
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
          transition: all 0.3s ease;
        }
        
        .card:hover {
          transform: translateY(-4px);
          box-shadow: 0 30px 80px rgba(0, 0, 0, 0.7);
        }
        
        .gradient-kamila {
          background: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%);
        }
        
        .gradient-ramon {
          background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
        }
        
        .glass {
          background: rgba(255, 255, 255, 0.05);
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        @keyframes fadeInUp {
          from {
            opacity: 0;
            transform: translateY(20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
        
        .animate-fade-in {
          animation: fadeInUp 0.6s ease-out;
        }
        
        .btn-primary {
          transition: all 0.2s ease;
        }
        
        .btn-primary:active {
          transform: scale(0.95);
        }
        
        .calendar-day {
          transition: all 0.2s ease;
        }
        
        .calendar-day:hover {
          transform: scale(1.05);
        }
      `}</style>
      
      {/* Header */}
      <div className="max-w-7xl mx-auto mb-8 animate-fade-in">
        <div className="flex items-center justify-between mb-6">
          <div>
            <h1 className="title-font text-5xl md:text-6xl mb-2 bg-gradient-to-r from-pink-500 via-purple-500 to-cyan-500 bg-clip-text text-transparent">
              üí™ Gym Tracker
            </h1>
            <p className="body-font text-slate-400 text-lg">Kamila & Ramon ‚Ä¢ Melhor Casal do Mundo üèÜ</p>
          </div>
          <div className="flex gap-2">
            <button
              onClick={() => setViewMode('dashboard')}
              className={`p-3 rounded-xl ${viewMode === 'dashboard' ? 'bg-purple-600' : 'glass'} btn-primary`}
            >
              <Dumbbell size={24} />
            </button>
            <button
              onClick={() => setViewMode('calendar')}
              className={`p-3 rounded-xl ${viewMode === 'calendar' ? 'bg-purple-600' : 'glass'} btn-primary`}
            >
              <Calendar size={24} />
            </button>
            <button
              onClick={() => setViewMode('charts')}
              className={`p-3 rounded-xl ${viewMode === 'charts' ? 'bg-purple-600' : 'glass'} btn-primary`}
            >
              <TrendingUp size={24} />
            </button>
          </div>
        </div>
      </div>

      <div className="max-w-7xl mx-auto">
        {viewMode === 'dashboard' && (
          <div className="space-y-6 animate-fade-in">
            {/* Data Atual */}
            <div className="card rounded-2xl p-6">
              <div className="flex items-center justify-between">
                <button
                  onClick={() => setCurrentDate(new Date(currentDate.setDate(currentDate.getDate() - 1)))}
                  className="p-2 rounded-lg glass hover:bg-white/10 btn-primary"
                >
                  <ChevronLeft size={24} />
                </button>
                <h2 className="title-font text-3xl">
                  {currentDate.toLocaleDateString('pt-BR', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                  })}
                </h2>
                <button
                  onClick={() => setCurrentDate(new Date(currentDate.setDate(currentDate.getDate() + 1)))}
                  className="p-2 rounded-lg glass hover:bg-white/10 btn-primary"
                  disabled={getDateKey(currentDate) >= getDateKey(new Date())}
                >
                  <ChevronRight size={24} />
                </button>
              </div>
            </div>

            {/* Check-in Cards */}
            <div className="grid md:grid-cols-2 gap-6">
              {/* Kamila */}
              <div className="card rounded-2xl p-8 relative overflow-hidden">
                <div className="absolute top-0 right-0 w-32 h-32 gradient-kamila opacity-20 blur-3xl rounded-full"></div>
                <div className="relative z-10">
                  <div className="flex items-center justify-between mb-6">
                    <div className="flex items-center gap-3">
                      <div className="w-12 h-12 rounded-full gradient-kamila flex items-center justify-center">
                        <User size={24} />
                      </div>
                      <h3 className="title-font text-2xl">Kamila</h3>
                    </div>
                    <Award className="text-pink-400" size={32} />
                  </div>
                  
                  <button
                    onClick={() => toggleGym('kamila')}
                    className={`w-full py-6 rounded-xl mb-4 title-font text-2xl btn-primary ${
                      stats.todayKamila 
                        ? 'gradient-kamila' 
                        : 'glass hover:bg-white/10'
                    }`}
                  >
                    {stats.todayKamila ? '‚úì FOI NA ACADEMIA' : 'REGISTRAR IDA'}
                  </button>
                  
                  <button
                    onClick={() => openWeightModal('kamila')}
                    className="w-full py-4 rounded-xl glass hover:bg-white/10 body-font btn-primary"
                  >
                    ‚öñÔ∏è Registrar Peso: {stats.lastKamilaWeight ? `${stats.lastKamilaWeight} kg` : 'Nenhum'}
                  </button>
                  
                  <div className="mt-6 grid grid-cols-2 gap-4">
                    <div className="glass p-4 rounded-xl">
                      <p className="text-slate-400 text-sm mb-1">Total de Idas</p>
                      <p className="title-font text-3xl text-pink-400">{stats.kamilaTotal}</p>
                    </div>
                    <div className="glass p-4 rounded-xl">
                      <p className="text-slate-400 text-sm mb-1">Dias Ativos</p>
                      <p className="title-font text-3xl text-pink-400">{stats.kamilaDays}</p>
                    </div>
                  </div>
                </div>
              </div>

              {/* Ramon */}
              <div className="card rounded-2xl p-8 relative overflow-hidden">
                <div className="absolute top-0 right-0 w-32 h-32 gradient-ramon opacity-20 blur-3xl rounded-full"></div>
                <div className="relative z-10">
                  <div className="flex items-center justify-between mb-6">
                    <div className="flex items-center gap-3">
                      <div className="w-12 h-12 rounded-full gradient-ramon flex items-center justify-center">
                        <User size={24} />
                      </div>
                      <h3 className="title-font text-2xl">Ramon</h3>
                    </div>
                    <Award className="text-cyan-400" size={32} />
                  </div>
                  
                  <button
                    onClick={() => toggleGym('ramon')}
                    className={`w-full py-6 rounded-xl mb-4 title-font text-2xl btn-primary ${
                      stats.todayRamon 
                        ? 'gradient-ramon' 
                        : 'glass hover:bg-white/10'
                    }`}
                  >
                    {stats.todayRamon ? '‚úì FOI NA ACADEMIA' : 'REGISTRAR IDA'}
                  </button>
                  
                  <button
                    onClick={() => openWeightModal('ramon')}
                    className="w-full py-4 rounded-xl glass hover:bg-white/10 body-font btn-primary"
                  >
                    ‚öñÔ∏è Registrar Peso: {stats.lastRamonWeight ? `${stats.lastRamonWeight} kg` : 'Nenhum'}
                  </button>
                  
                  <div className="mt-6 grid grid-cols-2 gap-4">
                    <div className="glass p-4 rounded-xl">
                      <p className="text-slate-400 text-sm mb-1">Total de Idas</p>
                      <p className="title-font text-3xl text-cyan-400">{stats.ramonTotal}</p>
                    </div>
                    <div className="glass p-4 rounded-xl">
                      <p className="text-slate-400 text-sm mb-1">Dias Ativos</p>
                      <p className="title-font text-3xl text-cyan-400">{stats.ramonDays}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* Quick Stats */}
            <div className="card rounded-2xl p-6">
              <h3 className="title-font text-2xl mb-4">üèÖ Estat√≠sticas R√°pidas</h3>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div className="glass p-4 rounded-xl text-center">
                  <p className="text-slate-400 text-sm mb-2">Total Combinado</p>
                  <p className="title-font text-3xl text-purple-400">{stats.kamilaTotal + stats.ramonTotal}</p>
                </div>
                <div className="glass p-4 rounded-xl text-center">
                  <p className="text-slate-400 text-sm mb-2">M√©dia/Pessoa</p>
                  <p className="title-font text-3xl text-purple-400">
                    {((stats.kamilaTotal + stats.ramonTotal) / 2).toFixed(1)}
                  </p>
                </div>
                <div className="glass p-4 rounded-xl text-center">
                  <p className="text-slate-400 text-sm mb-2">Dias Registrados</p>
                  <p className="title-font text-3xl text-purple-400">{Object.keys(data).length}</p>
                </div>
                <div className="glass p-4 rounded-xl text-center">
                  <p className="text-slate-400 text-sm mb-2">Hoje</p>
                  <p className="title-font text-3xl">
                    {stats.todayKamila && stats.todayRamon ? 'üí™üí™' : 
                     stats.todayKamila || stats.todayRamon ? 'üí™' : 'üò¥'}
                  </p>
                </div>
              </div>
            </div>
          </div>
        )}

        {viewMode === 'calendar' && (
          <div className="card rounded-2xl p-6 animate-fade-in">
            <div className="flex items-center justify-between mb-6">
              <h2 className="title-font text-3xl">
                {currentDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}
              </h2>
              <div className="flex gap-2">
                <button
                  onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() - 1)))}
                  className="p-2 rounded-lg glass hover:bg-white/10 btn-primary"
                >
                  <ChevronLeft size={24} />
                </button>
                <button
                  onClick={() => setCurrentDate(new Date())}
                  className="px-4 py-2 rounded-lg glass hover:bg-white/10 body-font btn-primary"
                >
                  Hoje
                </button>
                <button
                  onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() + 1)))}
                  className="p-2 rounded-lg glass hover:bg-white/10 btn-primary"
                >
                  <ChevronRight size={24} />
                </button>
              </div>
            </div>
            
            <div className="grid grid-cols-7 gap-2">
              {['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'].map(day => (
                <div key={day} className="text-center text-slate-400 font-semibold p-2">
                  {day}
                </div>
              ))}
              
              {Array.from({ length: monthData[0]?.date.getDay() || 0 }).map((_, i) => (
                <div key={`empty-${i}`} />
              ))}
              
              {monthData.map((day) => (
                <div
                  key={day.dateKey}
                  className={`calendar-day p-3 rounded-xl text-center cursor-pointer ${
                    day.kamilaGym && day.ramonGym
                      ? 'bg-gradient-to-br from-pink-500 to-cyan-500'
                      : day.kamilaGym
                      ? 'bg-pink-500/70'
                      : day.ramonGym
                      ? 'bg-cyan-500/70'
                      : 'glass'
                  }`}
                  onClick={() => setCurrentDate(new Date(day.date))}
                >
                  <div className="body-font font-semibold">
                    {day.date.getDate()}
                  </div>
                  <div className="text-xs mt-1">
                    {day.kamilaGym && 'üí™'}
                    {day.ramonGym && 'üí™'}
                  </div>
                </div>
              ))}
            </div>
            
            <div className="mt-6 flex flex-wrap gap-4 justify-center">
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 rounded bg-pink-500"></div>
                <span className="text-sm">Kamila</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 rounded bg-cyan-500"></div>
                <span className="text-sm">Ramon</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 rounded bg-gradient-to-r from-pink-500 to-cyan-500"></div>
                <span className="text-sm">Ambos</span>
              </div>
            </div>
          </div>
        )}

        {viewMode === 'charts' && (
          <div className="space-y-6 animate-fade-in">
            {/* Evolu√ß√£o de Peso */}
            <div className="card rounded-2xl p-6">
              <h2 className="title-font text-2xl mb-6">üìä Evolu√ß√£o de Peso (√öltimos 30 dias)</h2>
              <ResponsiveContainer width="100%" height={300}>
                <LineChart data={getWeightChartData()}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
                  <XAxis dataKey="date" stroke="#94a3b8" />
                  <YAxis stroke="#94a3b8" domain={['dataMin - 2', 'dataMax + 2']} />
                  <Tooltip 
                    contentStyle={{ 
                      backgroundColor: '#1e293b', 
                      border: '1px solid #334155',
                      borderRadius: '8px'
                    }} 
                  />
                  <Legend />
                  <Line 
                    type="monotone" 
                    dataKey="Kamila" 
                    stroke="#ec4899" 
                    strokeWidth={3}
                    dot={{ fill: '#ec4899', r: 4 }}
                  />
                  <Line 
                    type="monotone" 
                    dataKey="Ramon" 
                    stroke="#06b6d4" 
                    strokeWidth={3}
                    dot={{ fill: '#06b6d4', r: 4 }}
                  />
                </LineChart>
              </ResponsiveContainer>
            </div>

            {/* Frequ√™ncia Mensal */}
            <div className="card rounded-2xl p-6">
              <h2 className="title-font text-2xl mb-6">üìà Frequ√™ncia Mensal</h2>
              <ResponsiveContainer width="100%" height={300}>
                <BarChart data={getFrequencyChartData()}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
                  <XAxis dataKey="month" stroke="#94a3b8" />
                  <YAxis stroke="#94a3b8" />
                  <Tooltip 
                    contentStyle={{ 
                      backgroundColor: '#1e293b', 
                      border: '1px solid #334155',
                      borderRadius: '8px'
                    }} 
                  />
                  <Legend />
                  <Bar dataKey="Kamila" fill="#ec4899" radius={[8, 8, 0, 0]} />
                  <Bar dataKey="Ramon" fill="#06b6d4" radius={[8, 8, 0, 0]} />
                </BarChart>
              </ResponsiveContainer>
            </div>
          </div>
        )}
      </div>

      {/* Modal de Peso */}
      {showWeightModal && (
        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="card rounded-2xl p-8 max-w-md w-full animate-fade-in">
            <div className="flex items-center justify-between mb-6">
              <h3 className="title-font text-2xl">
                Peso - {selectedPerson === 'kamila' ? 'Kamila' : 'Ramon'}
              </h3>
              <button
                onClick={() => setShowWeightModal(false)}
                className="p-2 rounded-lg glass hover:bg-white/10 btn-primary"
              >
                <X size={24} />
              </button>
            </div>
            
            <input
              type="number"
              step="0.1"
              value={tempWeight}
              onChange={(e) => setTempWeight(e.target.value)}
              placeholder="Digite o peso em kg"
              className="w-full p-4 rounded-xl glass border border-white/20 text-white text-xl mb-6 body-font focus:outline-none focus:border-purple-500"
              autoFocus
            />
            
            <div className="flex gap-3">
              <button
                onClick={() => setShowWeightModal(false)}
                className="flex-1 py-4 rounded-xl glass hover:bg-white/10 body-font btn-primary"
              >
                Cancelar
              </button>
              <button
                onClick={saveWeight}
                className={`flex-1 py-4 rounded-xl body-font flex items-center justify-center gap-2 btn-primary ${
                  selectedPerson === 'kamila' ? 'gradient-kamila' : 'gradient-ramon'
                }`}
              >
                <Save size={20} />
                Salvar
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default GymTracker;
